<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (21) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: com.weather.sdk.client, class: DefaultOpenWeatherApiClient">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">/*</span>
<span class="source-line-no">002</span><span id="line-2"> * Copyright Â© 2025 by vyacheslav.v.pl@yandex.ru</span>
<span class="source-line-no">003</span><span id="line-3"> *</span>
<span class="source-line-no">004</span><span id="line-4"> * This code is licensed under the Creative Commons</span>
<span class="source-line-no">005</span><span id="line-5"> * Attribution-NonCommercial-NoDerivatives 4.0 International License.</span>
<span class="source-line-no">006</span><span id="line-6"> * To view a copy of this license, visit</span>
<span class="source-line-no">007</span><span id="line-7"> * https://creativecommons.org/licenses/by-nc-nd/4.0/</span>
<span class="source-line-no">008</span><span id="line-8"> */</span>
<span class="source-line-no">009</span><span id="line-9">package com.weather.sdk.client;</span>
<span class="source-line-no">010</span><span id="line-10"></span>
<span class="source-line-no">011</span><span id="line-11">import com.fasterxml.jackson.databind.ObjectMapper;</span>
<span class="source-line-no">012</span><span id="line-12">import com.weather.sdk.exception.ApiKeyException;</span>
<span class="source-line-no">013</span><span id="line-13">import com.weather.sdk.exception.CityNotFoundException;</span>
<span class="source-line-no">014</span><span id="line-14">import com.weather.sdk.exception.NetworkException;</span>
<span class="source-line-no">015</span><span id="line-15">import com.weather.sdk.exception.RateLimitException;</span>
<span class="source-line-no">016</span><span id="line-16">import com.weather.sdk.model.WeatherData;</span>
<span class="source-line-no">017</span><span id="line-17">import java.net.HttpURLConnection;</span>
<span class="source-line-no">018</span><span id="line-18">import java.net.URI;</span>
<span class="source-line-no">019</span><span id="line-19">import java.net.http.HttpClient;</span>
<span class="source-line-no">020</span><span id="line-20">import java.net.http.HttpRequest;</span>
<span class="source-line-no">021</span><span id="line-21">import java.net.http.HttpResponse;</span>
<span class="source-line-no">022</span><span id="line-22">import java.time.Duration;</span>
<span class="source-line-no">023</span><span id="line-23">import java.util.Objects;</span>
<span class="source-line-no">024</span><span id="line-24">import java.util.logging.Logger;</span>
<span class="source-line-no">025</span><span id="line-25">import org.slf4j.LoggerFactory;</span>
<span class="source-line-no">026</span><span id="line-26"></span>
<span class="source-line-no">027</span><span id="line-27">/**</span>
<span class="source-line-no">028</span><span id="line-28"> * Default implementation of the OpenWeatherApiClient interface.</span>
<span class="source-line-no">029</span><span id="line-29"> *</span>
<span class="source-line-no">030</span><span id="line-30"> * &lt;p&gt;This implementation provides HTTP communication with the OpenWeatherAPI service using Java</span>
<span class="source-line-no">031</span><span id="line-31"> * 17's HttpClient. It handles request construction, response parsing, error handling, and provides</span>
<span class="source-line-no">032</span><span id="line-32"> * thread-safe operations.</span>
<span class="source-line-no">033</span><span id="line-33"> *</span>
<span class="source-line-no">034</span><span id="line-34"> * &lt;p&gt;&lt;strong&gt;Implementation Details:&lt;/strong&gt;</span>
<span class="source-line-no">035</span><span id="line-35"> *</span>
<span class="source-line-no">036</span><span id="line-36"> * &lt;ul&gt;</span>
<span class="source-line-no">037</span><span id="line-37"> *   &lt;li&gt;Uses Java 17 HttpClient for HTTP communication</span>
<span class="source-line-no">038</span><span id="line-38"> *   &lt;li&gt;Implements connection and read timeout handling</span>
<span class="source-line-no">039</span><span id="line-39"> *   &lt;li&gt;Parses JSON responses using Jackson ObjectMapper</span>
<span class="source-line-no">040</span><span id="line-40"> *   &lt;li&gt;Maps HTTP status codes to appropriate exceptions</span>
<span class="source-line-no">041</span><span id="line-41"> *   &lt;li&gt;Thread-safe and can be called concurrently</span>
<span class="source-line-no">042</span><span id="line-42"> * &lt;/ul&gt;</span>
<span class="source-line-no">043</span><span id="line-43"> *</span>
<span class="source-line-no">044</span><span id="line-44"> * &lt;h2&gt;Request Configuration&lt;/h2&gt;</span>
<span class="source-line-no">045</span><span id="line-45"> *</span>
<span class="source-line-no">046</span><span id="line-46"> * &lt;ul&gt;</span>
<span class="source-line-no">047</span><span id="line-47"> *   &lt;li&gt;&lt;strong&gt;HTTP Method:&lt;/strong&gt; GET</span>
<span class="source-line-no">048</span><span id="line-48"> *   &lt;li&gt;&lt;strong&gt;Base URL:&lt;/strong&gt; {@value #API_ENDPOINT_URL}</span>
<span class="source-line-no">049</span><span id="line-49"> *   &lt;li&gt;&lt;strong&gt;Timeout:&lt;/strong&gt; Configurable (default: 10 seconds connection, 30 seconds read)</span>
<span class="source-line-no">050</span><span id="line-50"> *   &lt;li&gt;&lt;strong&gt;Headers:&lt;/strong&gt; Accept: application/json</span>
<span class="source-line-no">051</span><span id="line-51"> *   &lt;li&gt;&lt;strong&gt;Parameters:&lt;/strong&gt; q={cityName}, appid={apiKey}, units=metric</span>
<span class="source-line-no">052</span><span id="line-52"> * &lt;/ul&gt;</span>
<span class="source-line-no">053</span><span id="line-53"> *</span>
<span class="source-line-no">054</span><span id="line-54"> * &lt;h2&gt;Error Handling&lt;/h2&gt;</span>
<span class="source-line-no">055</span><span id="line-55"> *</span>
<span class="source-line-no">056</span><span id="line-56"> * &lt;ul&gt;</span>
<span class="source-line-no">057</span><span id="line-57"> *   &lt;li&gt;&lt;strong&gt;HTTP 200:&lt;/strong&gt; Parse JSON to WeatherData</span>
<span class="source-line-no">058</span><span id="line-58"> *   &lt;li&gt;&lt;strong&gt;HTTP 401:&lt;/strong&gt; Throw ApiKeyException</span>
<span class="source-line-no">059</span><span id="line-59"> *   &lt;li&gt;&lt;strong&gt;HTTP 404:&lt;/strong&gt; Throw CityNotFoundException</span>
<span class="source-line-no">060</span><span id="line-60"> *   &lt;li&gt;&lt;strong&gt;HTTP 429:&lt;/strong&gt; Throw RateLimitException (includes Retry-After header)</span>
<span class="source-line-no">061</span><span id="line-61"> *   &lt;li&gt;&lt;strong&gt;HTTP 5xx:&lt;/strong&gt; Throw NetworkException</span>
<span class="source-line-no">062</span><span id="line-62"> *   &lt;li&gt;&lt;strong&gt;Network errors:&lt;/strong&gt; Throw NetworkException</span>
<span class="source-line-no">063</span><span id="line-63"> * &lt;/ul&gt;</span>
<span class="source-line-no">064</span><span id="line-64"> *</span>
<span class="source-line-no">065</span><span id="line-65"> * @since 1.0.0</span>
<span class="source-line-no">066</span><span id="line-66"> * @see OpenWeatherApiClient</span>
<span class="source-line-no">067</span><span id="line-67"> * @see WeatherData</span>
<span class="source-line-no">068</span><span id="line-68"> */</span>
<span class="source-line-no">069</span><span id="line-69">@SuppressWarnings({"PMD.GodClass", "PMD.TooManyMethods", "CT_CONSTRUCTOR_THROW"})</span>
<span class="source-line-no">070</span><span id="line-70">public class DefaultOpenWeatherApiClient implements OpenWeatherApiClient {</span>
<span class="source-line-no">071</span><span id="line-71"></span>
<span class="source-line-no">072</span><span id="line-72">  /** Default connection timeout in seconds. */</span>
<span class="source-line-no">073</span><span id="line-73">  private static final int DEF_CONN_TIMEOUT = 10;</span>
<span class="source-line-no">074</span><span id="line-74"></span>
<span class="source-line-no">075</span><span id="line-75">  /** Default read timeout in seconds. */</span>
<span class="source-line-no">076</span><span id="line-76">  private static final int DEF_READ_TIMEOUT = 30;</span>
<span class="source-line-no">077</span><span id="line-77"></span>
<span class="source-line-no">078</span><span id="line-78">  /** HTTP status code for server error responses. */</span>
<span class="source-line-no">079</span><span id="line-79">  private static final int SERVER_ERR_STATUS = 500;</span>
<span class="source-line-no">080</span><span id="line-80"></span>
<span class="source-line-no">081</span><span id="line-81">  /** HTTP status code for unauthorized responses. */</span>
<span class="source-line-no">082</span><span id="line-82">  private static final int UNAUTH_STATUS = 401;</span>
<span class="source-line-no">083</span><span id="line-83"></span>
<span class="source-line-no">084</span><span id="line-84">  /** HTTP status code for not found responses. */</span>
<span class="source-line-no">085</span><span id="line-85">  private static final int NOT_FOUND_STATUS = 404;</span>
<span class="source-line-no">086</span><span id="line-86"></span>
<span class="source-line-no">087</span><span id="line-87">  /** HTTP status code for rate limit exceeded responses. */</span>
<span class="source-line-no">088</span><span id="line-88">  private static final int RATE_LIMIT_STATUS = 429;</span>
<span class="source-line-no">089</span><span id="line-89"></span>
<span class="source-line-no">090</span><span id="line-90">  // Maximum number of retry attempts and delay are now configurable</span>
<span class="source-line-no">091</span><span id="line-91">  // These constants are no longer used as the values are now passed via</span>
<span class="source-line-no">092</span><span id="line-92">  // configuration</span>
<span class="source-line-no">093</span><span id="line-93"></span>
<span class="source-line-no">094</span><span id="line-94">  /** Maximum number of retry attempts. */</span>
<span class="source-line-no">095</span><span id="line-95">  private final int maxRetries;</span>
<span class="source-line-no">096</span><span id="line-96"></span>
<span class="source-line-no">097</span><span id="line-97">  /** Delay between retry attempts in milliseconds. */</span>
<span class="source-line-no">098</span><span id="line-98">  private final long retryDelayMs;</span>
<span class="source-line-no">099</span><span id="line-99"></span>
<span class="source-line-no">100</span><span id="line-100">  /** Jackson ObjectMapper for JSON parsing. */</span>
<span class="source-line-no">101</span><span id="line-101">  private final ObjectMapper objectMapper;</span>
<span class="source-line-no">102</span><span id="line-102"></span>
<span class="source-line-no">103</span><span id="line-103">  /** HTTP client for making requests. */</span>
<span class="source-line-no">104</span><span id="line-104">  private final HttpClient httpClient;</span>
<span class="source-line-no">105</span><span id="line-105"></span>
<span class="source-line-no">106</span><span id="line-106">  /** Connection timeout duration. */</span>
<span class="source-line-no">107</span><span id="line-107">  private final Duration connectionTimeout;</span>
<span class="source-line-no">108</span><span id="line-108"></span>
<span class="source-line-no">109</span><span id="line-109">  /** Logger for this class. */</span>
<span class="source-line-no">110</span><span id="line-110">  private static final org.slf4j.Logger LOGGER =</span>
<span class="source-line-no">111</span><span id="line-111">      LoggerFactory.getLogger(DefaultOpenWeatherApiClient.class);</span>
<span class="source-line-no">112</span><span id="line-112"></span>
<span class="source-line-no">113</span><span id="line-113">  /** API endpoint URL for OpenWeatherMap service. */</span>
<span class="source-line-no">114</span><span id="line-114">  private static final String API_ENDPOINT_URL = "https://api.openweathermap.org/data/2.5/weather";</span>
<span class="source-line-no">115</span><span id="line-115"></span>
<span class="source-line-no">116</span><span id="line-116">  /** Query parameter name for city. */</span>
<span class="source-line-no">117</span><span id="line-117">  private static final String PARAM_CITY = "q";</span>
<span class="source-line-no">118</span><span id="line-118"></span>
<span class="source-line-no">119</span><span id="line-119">  /** Query parameter name for API key. */</span>
<span class="source-line-no">120</span><span id="line-120">  private static final String PARAM_API_KEY = "appid";</span>
<span class="source-line-no">121</span><span id="line-121"></span>
<span class="source-line-no">122</span><span id="line-122">  /** Query parameter name for units. */</span>
<span class="source-line-no">123</span><span id="line-123">  private static final String PARAM_UNITS = "units";</span>
<span class="source-line-no">124</span><span id="line-124"></span>
<span class="source-line-no">125</span><span id="line-125">  /** Standard units value. */</span>
<span class="source-line-no">126</span><span id="line-126">  private static final String UNITS_STANDARD = "standard";</span>
<span class="source-line-no">127</span><span id="line-127"></span>
<span class="source-line-no">128</span><span id="line-128">  /**</span>
<span class="source-line-no">129</span><span id="line-129">   * Constructs a new DefaultOpenWeatherApiClient with default timeout settings.</span>
<span class="source-line-no">130</span><span id="line-130">   *</span>
<span class="source-line-no">131</span><span id="line-131">   * &lt;p&gt;This constructor uses default timeouts: 10 seconds for connection, 30 seconds for read</span>
<span class="source-line-no">132</span><span id="line-132">   * operations, 3 for max retries, and 500ms for retry delay.</span>
<span class="source-line-no">133</span><span id="line-133">   *</span>
<span class="source-line-no">134</span><span id="line-134">   * @param httpClient the HTTP client to use for requests (must not be null)</span>
<span class="source-line-no">135</span><span id="line-135">   * @throws NullPointerException if httpClient is null</span>
<span class="source-line-no">136</span><span id="line-136">   */</span>
<span class="source-line-no">137</span><span id="line-137">  public DefaultOpenWeatherApiClient(final HttpClient httpClient) {</span>
<span class="source-line-no">138</span><span id="line-138">    this(httpClient, DEF_CONN_TIMEOUT, DEF_READ_TIMEOUT);</span>
<span class="source-line-no">139</span><span id="line-139">  }</span>
<span class="source-line-no">140</span><span id="line-140"></span>
<span class="source-line-no">141</span><span id="line-141">  /**</span>
<span class="source-line-no">142</span><span id="line-142">   * Constructs a new DefaultOpenWeatherApiClient with custom timeout settings.</span>
<span class="source-line-no">143</span><span id="line-143">   *</span>
<span class="source-line-no">144</span><span id="line-144">   * @param httpClient the HTTP client to use for requests (must not be null)</span>
<span class="source-line-no">145</span><span id="line-145">   * @param connTimeoutSec the connection timeout in seconds (must be positive)</span>
<span class="source-line-no">146</span><span id="line-146">   * @param readTimeoutSec the read timeout in seconds (must be positive)</span>
<span class="source-line-no">147</span><span id="line-147">   * @throws NullPointerException if httpClient is null</span>
<span class="source-line-no">148</span><span id="line-148">   * @throws IllegalArgumentException if either timeout is not positive</span>
<span class="source-line-no">149</span><span id="line-149">   */</span>
<span class="source-line-no">150</span><span id="line-150">  public DefaultOpenWeatherApiClient(</span>
<span class="source-line-no">151</span><span id="line-151">      final HttpClient httpClient, final int connTimeoutSec, final int readTimeoutSec) {</span>
<span class="source-line-no">152</span><span id="line-152">    this(httpClient, connTimeoutSec, readTimeoutSec, 3, 500L);</span>
<span class="source-line-no">153</span><span id="line-153">  }</span>
<span class="source-line-no">154</span><span id="line-154"></span>
<span class="source-line-no">155</span><span id="line-155">  /**</span>
<span class="source-line-no">156</span><span id="line-156">   * Constructs a new DefaultOpenWeatherApiClient with custom timeout and retry settings.</span>
<span class="source-line-no">157</span><span id="line-157">   *</span>
<span class="source-line-no">158</span><span id="line-158">   * @param httpClient the HTTP client to use for requests (must not be null)</span>
<span class="source-line-no">159</span><span id="line-159">   * @param connTimeoutSec the connection timeout in seconds (must be positive)</span>
<span class="source-line-no">160</span><span id="line-160">   * @param readTimeoutSec the read timeout in seconds (must be positive)</span>
<span class="source-line-no">161</span><span id="line-161">   * @param maxRetries the maximum number of retry attempts (must be non-negative)</span>
<span class="source-line-no">162</span><span id="line-162">   * @param retryDelayMs the delay between retry attempts in milliseconds (must be positive)</span>
<span class="source-line-no">163</span><span id="line-163">   * @throws NullPointerException if httpClient is null</span>
<span class="source-line-no">164</span><span id="line-164">   * @throws IllegalArgumentException if any parameter is invalid</span>
<span class="source-line-no">165</span><span id="line-165">   */</span>
<span class="source-line-no">166</span><span id="line-166">  @SuppressWarnings("CT_CONSTRUCTOR_THROW")</span>
<span class="source-line-no">167</span><span id="line-167">  public DefaultOpenWeatherApiClient(</span>
<span class="source-line-no">168</span><span id="line-168">      final HttpClient httpClient,</span>
<span class="source-line-no">169</span><span id="line-169">      final int connTimeoutSec,</span>
<span class="source-line-no">170</span><span id="line-170">      final int readTimeoutSec,</span>
<span class="source-line-no">171</span><span id="line-171">      final int maxRetries,</span>
<span class="source-line-no">172</span><span id="line-172">      final long retryDelayMs) {</span>
<span class="source-line-no">173</span><span id="line-173">    // Initialize fields first to avoid partial initialization</span>
<span class="source-line-no">174</span><span id="line-174">    this.httpClient = Objects.requireNonNull(httpClient, "HTTP client must not be null");</span>
<span class="source-line-no">175</span><span id="line-175">    this.connectionTimeout = Duration.ofSeconds(connTimeoutSec);</span>
<span class="source-line-no">176</span><span id="line-176">    this.objectMapper = new ObjectMapper();</span>
<span class="source-line-no">177</span><span id="line-177">    this.maxRetries = maxRetries;</span>
<span class="source-line-no">178</span><span id="line-178">    this.retryDelayMs = retryDelayMs;</span>
<span class="source-line-no">179</span><span id="line-179"></span>
<span class="source-line-no">180</span><span id="line-180">    // Validate parameters after field initialization</span>
<span class="source-line-no">181</span><span id="line-181">    if (connTimeoutSec &lt;= 0) {</span>
<span class="source-line-no">182</span><span id="line-182">      throw new IllegalArgumentException(</span>
<span class="source-line-no">183</span><span id="line-183">          "Connection timeout must be positive, was: " + connTimeoutSec);</span>
<span class="source-line-no">184</span><span id="line-184">    }</span>
<span class="source-line-no">185</span><span id="line-185">    if (readTimeoutSec &lt;= 0) {</span>
<span class="source-line-no">186</span><span id="line-186">      throw new IllegalArgumentException("Read timeout must be positive, was: " + readTimeoutSec);</span>
<span class="source-line-no">187</span><span id="line-187">    }</span>
<span class="source-line-no">188</span><span id="line-188">    if (maxRetries &lt; 0) {</span>
<span class="source-line-no">189</span><span id="line-189">      throw new IllegalArgumentException("Max retries must be non-negative, was: " + maxRetries);</span>
<span class="source-line-no">190</span><span id="line-190">    }</span>
<span class="source-line-no">191</span><span id="line-191">    if (retryDelayMs &lt;= 0) {</span>
<span class="source-line-no">192</span><span id="line-192">      throw new IllegalArgumentException("Retry delay must be positive, was: " + retryDelayMs);</span>
<span class="source-line-no">193</span><span id="line-193">    }</span>
<span class="source-line-no">194</span><span id="line-194">  }</span>
<span class="source-line-no">195</span><span id="line-195"></span>
<span class="source-line-no">196</span><span id="line-196">  /**</span>
<span class="source-line-no">197</span><span id="line-197">   * Fetches current weather data for the specified city.</span>
<span class="source-line-no">198</span><span id="line-198">   *</span>
<span class="source-line-no">199</span><span id="line-199">   * &lt;p&gt;This method makes an HTTP GET request to the OpenWeatherAPI service to retrieve current</span>
<span class="source-line-no">200</span><span id="line-200">   * weather information for the given city. The method handles all aspects of the HTTP</span>
<span class="source-line-no">201</span><span id="line-201">   * communication including request construction, response parsing, and error handling.</span>
<span class="source-line-no">202</span><span id="line-202">   *</span>
<span class="source-line-no">203</span><span id="line-203">   * &lt;h4&gt;Request Construction&lt;/h4&gt;</span>
<span class="source-line-no">204</span><span id="line-204">   *</span>
<span class="source-line-no">205</span><span id="line-205">   * &lt;ul&gt;</span>
<span class="source-line-no">206</span><span id="line-206">   *   &lt;li&gt;URL: {@value #API_ENDPOINT_URL}</span>
<span class="source-line-no">207</span><span id="line-207">   *   &lt;li&gt;Method: GET</span>
<span class="source-line-no">208</span><span id="line-208">   *   &lt;li&gt;Parameters: q={cityName}, appid={apiKey}, units=metric</span>
<span class="source-line-no">209</span><span id="line-209">   *   &lt;li&gt;Headers: Accept: application/json</span>
<span class="source-line-no">210</span><span id="line-210">   *   &lt;li&gt;Timeout: Uses configured connection and read timeouts</span>
<span class="source-line-no">211</span><span id="line-211">   * &lt;/ul&gt;</span>
<span class="source-line-no">212</span><span id="line-212">   *</span>
<span class="source-line-no">213</span><span id="line-213">   * &lt;h4&gt;Response Handling&lt;/h4&gt;</span>
<span class="source-line-no">214</span><span id="line-214">   *</span>
<span class="source-line-no">215</span><span id="line-215">   * &lt;ul&gt;</span>
<span class="source-line-no">216</span><span id="line-216">   *   &lt;li&gt;&lt;strong&gt;HTTP 200&lt;/strong&gt;: Parse JSON response to {@link WeatherData}</span>
<span class="source-line-no">217</span><span id="line-217">   *   &lt;li&gt;&lt;strong&gt;HTTP 401&lt;/strong&gt;: Throw {@link ApiKeyException}</span>
<span class="source-line-no">218</span><span id="line-218">   *   &lt;li&gt;&lt;strong&gt;HTTP 404&lt;/strong&gt;: Throw {@link CityNotFoundException}</span>
<span class="source-line-no">219</span><span id="line-219">   *   &lt;li&gt;&lt;strong&gt;HTTP 429&lt;/strong&gt;: Throw {@link RateLimitException}</span>
<span class="source-line-no">220</span><span id="line-220">   *   &lt;li&gt;&lt;strong&gt;HTTP 5xx&lt;/strong&gt;: Throw {@link NetworkException}</span>
<span class="source-line-no">221</span><span id="line-221">   *   &lt;li&gt;&lt;strong&gt;Network failure&lt;/strong&gt;: Throw {@link NetworkException}</span>
<span class="source-line-no">222</span><span id="line-222">   * &lt;/ul&gt;</span>
<span class="source-line-no">223</span><span id="line-223">   *</span>
<span class="source-line-no">224</span><span id="line-224">   * &lt;h4&gt;Retry Logic&lt;/h4&gt;</span>
<span class="source-line-no">225</span><span id="line-225">   *</span>
<span class="source-line-no">226</span><span id="line-226">   * &lt;p&gt;The SDK implements automatic retry logic for network-related failures:</span>
<span class="source-line-no">227</span><span id="line-227">   *</span>
<span class="source-line-no">228</span><span id="line-228">   * &lt;ul&gt;</span>
<span class="source-line-no">229</span><span id="line-229">   *   &lt;li&gt;Maximum retry attempts configured via SDK configuration</span>
<span class="source-line-no">230</span><span id="line-230">   *   &lt;li&gt;Fixed delay between retries configured via SDK configuration</span>
<span class="source-line-no">231</span><span id="line-231">   *   &lt;li&gt;Retries on network exceptions (connection failures, timeouts)</span>
<span class="source-line-no">232</span><span id="line-232">   *   &lt;li&gt;Retries on server errors (HTTP 5xx responses)</span>
<span class="source-line-no">233</span><span id="line-233">   *   &lt;li&gt;No retries on client errors (HTTP 4xx responses) - these are not recoverable via retry</span>
<span class="source-line-no">234</span><span id="line-234">   *   &lt;li&gt;No retries on {@link RateLimitException}, {@link ApiKeyException}, or {@link</span>
<span class="source-line-no">235</span><span id="line-235">   *       CityNotFoundException}</span>
<span class="source-line-no">236</span><span id="line-236">   *   &lt;li&gt;Logs retry attempts at DEBUG level</span>
<span class="source-line-no">237</span><span id="line-237">   * &lt;/ul&gt;</span>
<span class="source-line-no">238</span><span id="line-238">   *</span>
<span class="source-line-no">239</span><span id="line-239">   * &lt;h4&gt;Thread Safety&lt;/h4&gt;</span>
<span class="source-line-no">240</span><span id="line-240">   *</span>
<span class="source-line-no">241</span><span id="line-241">   * This method is thread-safe and can be called concurrently by multiple threads.</span>
<span class="source-line-no">242</span><span id="line-242">   *</span>
<span class="source-line-no">243</span><span id="line-243">   * @param cityName the name of the city to fetch weather for (must not be null or empty)</span>
<span class="source-line-no">244</span><span id="line-244">   * @param apiKey the OpenWeatherAPI authentication key (must not be null or empty)</span>
<span class="source-line-no">245</span><span id="line-245">   * @return the current weather data for the specified city</span>
<span class="source-line-no">246</span><span id="line-246">   * @throws ApiKeyException if the API key is invalid, missing, or unauthorized</span>
<span class="source-line-no">247</span><span id="line-247">   * @throws CityNotFoundException if the specified city cannot be found</span>
<span class="source-line-no">248</span><span id="line-248">   * @throws RateLimitException if the API rate limit has been exceeded</span>
<span class="source-line-no">249</span><span id="line-249">   * @throws NetworkException if a network error occurs during the request</span>
<span class="source-line-no">250</span><span id="line-250">   * @throws IllegalArgumentException if cityName or apiKey is null or empty</span>
<span class="source-line-no">251</span><span id="line-251">   */</span>
<span class="source-line-no">252</span><span id="line-252">  @Override</span>
<span class="source-line-no">253</span><span id="line-253">  public WeatherData fetchWeather(final String cityName, final String apiKey)</span>
<span class="source-line-no">254</span><span id="line-254">      throws ApiKeyException, CityNotFoundException, RateLimitException, NetworkException {</span>
<span class="source-line-no">255</span><span id="line-255">    validateParameters(cityName, apiKey);</span>
<span class="source-line-no">256</span><span id="line-256">    return executeWithRetry(cityName, apiKey);</span>
<span class="source-line-no">257</span><span id="line-257">  }</span>
<span class="source-line-no">258</span><span id="line-258"></span>
<span class="source-line-no">259</span><span id="line-259">  /**</span>
<span class="source-line-no">260</span><span id="line-260">   * Executes the weather request with retry logic.</span>
<span class="source-line-no">261</span><span id="line-261">   *</span>
<span class="source-line-no">262</span><span id="line-262">   * @param cityName the name of the city to fetch weather for</span>
<span class="source-line-no">263</span><span id="line-263">   * @param apiKey the OpenWeatherAPI authentication key</span>
<span class="source-line-no">264</span><span id="line-264">   * @return the current weather data for the specified city</span>
<span class="source-line-no">265</span><span id="line-265">   * @throws ApiKeyException if the API key is invalid, missing, or unauthorized</span>
<span class="source-line-no">266</span><span id="line-266">   * @throws CityNotFoundException if the specified city cannot be found</span>
<span class="source-line-no">267</span><span id="line-267">   * @throws RateLimitException if the API rate limit has been exceeded</span>
<span class="source-line-no">268</span><span id="line-268">   * @throws NetworkException if a network error occurs during the request</span>
<span class="source-line-no">269</span><span id="line-269">   */</span>
<span class="source-line-no">270</span><span id="line-270">  @SuppressWarnings({</span>
<span class="source-line-no">271</span><span id="line-271">    "PMD.CognitiveComplexity",</span>
<span class="source-line-no">272</span><span id="line-272">    "PMD.CyclomaticComplexity",</span>
<span class="source-line-no">273</span><span id="line-273">    "PMD.AvoidRethrowingException"</span>
<span class="source-line-no">274</span><span id="line-274">  })</span>
<span class="source-line-no">275</span><span id="line-275">  private WeatherData executeWithRetry(final String cityName, final String apiKey)</span>
<span class="source-line-no">276</span><span id="line-276">      throws ApiKeyException, CityNotFoundException, RateLimitException, NetworkException {</span>
<span class="source-line-no">277</span><span id="line-277">    int attempts = 0;</span>
<span class="source-line-no">278</span><span id="line-278">    Exception lastException = null;</span>
<span class="source-line-no">279</span><span id="line-279">    // Extract BodyHandler outside the loop to avoid object instantiation in loops</span>
<span class="source-line-no">280</span><span id="line-280">    final HttpResponse.BodyHandler&lt;String&gt; bodyHandler = HttpResponse.BodyHandlers.ofString();</span>
<span class="source-line-no">281</span><span id="line-281"></span>
<span class="source-line-no">282</span><span id="line-282">    while (attempts &lt; maxRetries) {</span>
<span class="source-line-no">283</span><span id="line-283">      try {</span>
<span class="source-line-no">284</span><span id="line-284">        final HttpRequest request = buildRequest(cityName, apiKey);</span>
<span class="source-line-no">285</span><span id="line-285">        final HttpResponse&lt;String&gt; response = httpClient.send(request, bodyHandler);</span>
<span class="source-line-no">286</span><span id="line-286">        return handleResponse(response);</span>
<span class="source-line-no">287</span><span id="line-287">      } catch (final java.io.IOException ioException) {</span>
<span class="source-line-no">288</span><span id="line-288">        lastException = createNetworkException(ioException);</span>
<span class="source-line-no">289</span><span id="line-289">        attempts = handleRetryOnException(attempts, "Network error", ioException.getMessage());</span>
<span class="source-line-no">290</span><span id="line-290">        if (attempts &gt;= maxRetries) {</span>
<span class="source-line-no">291</span><span id="line-291">          break; // Exit the loop to throw the final exception</span>
<span class="source-line-no">292</span><span id="line-292">        }</span>
<span class="source-line-no">293</span><span id="line-293">      } catch (final InterruptedException e) {</span>
<span class="source-line-no">294</span><span id="line-294">        Thread.currentThread().interrupt();</span>
<span class="source-line-no">295</span><span id="line-295">        throw new NetworkException(</span>
<span class="source-line-no">296</span><span id="line-296">            "Request was interrupted while fetching weather data", API_ENDPOINT_URL, null, e);</span>
<span class="source-line-no">297</span><span id="line-297">      } catch (final NetworkException networkException) {</span>
<span class="source-line-no">298</span><span id="line-298">        if (shouldRetryNetworkException(networkException)) {</span>
<span class="source-line-no">299</span><span id="line-299">          lastException = networkException;</span>
<span class="source-line-no">300</span><span id="line-300">          attempts =</span>
<span class="source-line-no">301</span><span id="line-301">              handleRetryOnException(attempts, "Server error", networkException.getMessage());</span>
<span class="source-line-no">302</span><span id="line-302">          if (attempts &gt;= maxRetries) {</span>
<span class="source-line-no">303</span><span id="line-303">            break; // Exit the loop to throw the final exception</span>
<span class="source-line-no">304</span><span id="line-304">          }</span>
<span class="source-line-no">305</span><span id="line-305">        } else {</span>
<span class="source-line-no">306</span><span id="line-306">          // For client errors (4xx), do not retry - throw immediately</span>
<span class="source-line-no">307</span><span id="line-307">          throw networkException;</span>
<span class="source-line-no">308</span><span id="line-308">        }</span>
<span class="source-line-no">309</span><span id="line-309">      } catch (@SuppressWarnings("PMD.AvoidRethrowingException")</span>
<span class="source-line-no">310</span><span id="line-310">          final RateLimitException</span>
<span class="source-line-no">311</span><span id="line-311">          | ApiKeyException</span>
<span class="source-line-no">312</span><span id="line-312">          | CityNotFoundException e) {</span>
<span class="source-line-no">313</span><span id="line-313">        // Do not retry on these exceptions - throw immediately</span>
<span class="source-line-no">314</span><span id="line-314">        throw e;</span>
<span class="source-line-no">315</span><span id="line-315">      }</span>
<span class="source-line-no">316</span><span id="line-316">    }</span>
<span class="source-line-no">317</span><span id="line-317"></span>
<span class="source-line-no">318</span><span id="line-318">    // If we've exhausted all retries, throw the final exception</span>
<span class="source-line-no">319</span><span id="line-319">    if (attempts &gt;= maxRetries &amp;&amp; lastException != null) {</span>
<span class="source-line-no">320</span><span id="line-320">      // Preserve the HTTP status code from the original exception if it's a</span>
<span class="source-line-no">321</span><span id="line-321">      // NetworkException</span>
<span class="source-line-no">322</span><span id="line-322">      Integer origStatusCode = null;</span>
<span class="source-line-no">323</span><span id="line-323">      String origMessage = lastException.getMessage();</span>
<span class="source-line-no">324</span><span id="line-324">      if (lastException instanceof NetworkException) {</span>
<span class="source-line-no">325</span><span id="line-325">        final NetworkException networkEx = (NetworkException) lastException;</span>
<span class="source-line-no">326</span><span id="line-326">        origStatusCode = networkEx.getHttpStatusCode();</span>
<span class="source-line-no">327</span><span id="line-327">        // Include original message in the final message to preserve test expectations</span>
<span class="source-line-no">328</span><span id="line-328">        origMessage = networkEx.getMessage();</span>
<span class="source-line-no">329</span><span id="line-329">      }</span>
<span class="source-line-no">330</span><span id="line-330">      final String finalMessage =</span>
<span class="source-line-no">331</span><span id="line-331">          "Failed to fetch weather data after "</span>
<span class="source-line-no">332</span><span id="line-332">              + maxRetries</span>
<span class="source-line-no">333</span><span id="line-333">              + " attempts. Original error: "</span>
<span class="source-line-no">334</span><span id="line-334">              + origMessage;</span>
<span class="source-line-no">335</span><span id="line-335">      throw new NetworkException(finalMessage, API_ENDPOINT_URL, origStatusCode, lastException);</span>
<span class="source-line-no">336</span><span id="line-336">    }</span>
<span class="source-line-no">337</span><span id="line-337"></span>
<span class="source-line-no">338</span><span id="line-338">    // This should never be reached due to the logic above, but added for</span>
<span class="source-line-no">339</span><span id="line-339">    // completeness</span>
<span class="source-line-no">340</span><span id="line-340">    throw new NetworkException(</span>
<span class="source-line-no">341</span><span id="line-341">        "Unexpected end of retry loop reached - this should never happen", API_ENDPOINT_URL, null);</span>
<span class="source-line-no">342</span><span id="line-342">  }</span>
<span class="source-line-no">343</span><span id="line-343"></span>
<span class="source-line-no">344</span><span id="line-344">  /**</span>
<span class="source-line-no">345</span><span id="line-345">   * Determines if a NetworkException should be retried.</span>
<span class="source-line-no">346</span><span id="line-346">   *</span>
<span class="source-line-no">347</span><span id="line-347">   * @param networkException the NetworkException to check</span>
<span class="source-line-no">348</span><span id="line-348">   * @return true if the exception should be retried, false otherwise</span>
<span class="source-line-no">349</span><span id="line-349">   */</span>
<span class="source-line-no">350</span><span id="line-350">  private boolean shouldRetryNetworkException(final NetworkException networkException) {</span>
<span class="source-line-no">351</span><span id="line-351">    return networkException.isServerError() || networkException.isConnectionError();</span>
<span class="source-line-no">352</span><span id="line-352">  }</span>
<span class="source-line-no">353</span><span id="line-353"></span>
<span class="source-line-no">354</span><span id="line-354">  /**</span>
<span class="source-line-no">355</span><span id="line-355">   * Handles retry attempt on exception.</span>
<span class="source-line-no">356</span><span id="line-356">   *</span>
<span class="source-line-no">357</span><span id="line-357">   * @param currentAttempt the current attempt number</span>
<span class="source-line-no">358</span><span id="line-358">   * @param errorType the type of error (for logging)</span>
<span class="source-line-no">359</span><span id="line-359">   * @param errorMessage the error message</span>
<span class="source-line-no">360</span><span id="line-360">   * @return the updated attempt number</span>
<span class="source-line-no">361</span><span id="line-361">   * @throws NetworkException if max retries are exceeded</span>
<span class="source-line-no">362</span><span id="line-362">   */</span>
<span class="source-line-no">363</span><span id="line-363">  private int handleRetryOnException(</span>
<span class="source-line-no">364</span><span id="line-364">      final int currentAttempt, final String errorType, final String errorMessage)</span>
<span class="source-line-no">365</span><span id="line-365">      throws NetworkException {</span>
<span class="source-line-no">366</span><span id="line-366">    handleRetryAttempt(errorType, currentAttempt, errorMessage);</span>
<span class="source-line-no">367</span><span id="line-367">    waitForRetry();</span>
<span class="source-line-no">368</span><span id="line-368">    return currentAttempt + 1;</span>
<span class="source-line-no">369</span><span id="line-369">  }</span>
<span class="source-line-no">370</span><span id="line-370"></span>
<span class="source-line-no">371</span><span id="line-371">  /**</span>
<span class="source-line-no">372</span><span id="line-372">   * Handles a retry attempt by logging the error.</span>
<span class="source-line-no">373</span><span id="line-373">   *</span>
<span class="source-line-no">374</span><span id="line-374">   * @param errorType the type of error (for logging)</span>
<span class="source-line-no">375</span><span id="line-375">   * @param attempts the current number of attempts made</span>
<span class="source-line-no">376</span><span id="line-376">   * @param message the error message</span>
<span class="source-line-no">377</span><span id="line-377">   */</span>
<span class="source-line-no">378</span><span id="line-378">  private void handleRetryAttempt(</span>
<span class="source-line-no">379</span><span id="line-379">      final String errorType, final int attempts, final String message) {</span>
<span class="source-line-no">380</span><span id="line-380">    if (LOGGER.isDebugEnabled() &amp;&amp; attempts &lt; maxRetries - 1) {</span>
<span class="source-line-no">381</span><span id="line-381">      LOGGER.debug(</span>
<span class="source-line-no">382</span><span id="line-382">          "{} on attempt {}/{}: {}. Retrying in {}ms...",</span>
<span class="source-line-no">383</span><span id="line-383">          errorType,</span>
<span class="source-line-no">384</span><span id="line-384">          attempts + 1,</span>
<span class="source-line-no">385</span><span id="line-385">          maxRetries,</span>
<span class="source-line-no">386</span><span id="line-386">          message,</span>
<span class="source-line-no">387</span><span id="line-387">          retryDelayMs);</span>
<span class="source-line-no">388</span><span id="line-388">    }</span>
<span class="source-line-no">389</span><span id="line-389">  }</span>
<span class="source-line-no">390</span><span id="line-390"></span>
<span class="source-line-no">391</span><span id="line-391">  /**</span>
<span class="source-line-no">392</span><span id="line-392">   * Creates a NetworkException from an IOException.</span>
<span class="source-line-no">393</span><span id="line-393">   *</span>
<span class="source-line-no">394</span><span id="line-394">   * @param ioException the IOException to convert</span>
<span class="source-line-no">395</span><span id="line-395">   * @return a NetworkException wrapping the IOException</span>
<span class="source-line-no">396</span><span id="line-396">   */</span>
<span class="source-line-no">397</span><span id="line-397">  private NetworkException createNetworkException(final java.io.IOException ioException) {</span>
<span class="source-line-no">398</span><span id="line-398">    return new NetworkException(</span>
<span class="source-line-no">399</span><span id="line-399">        "Network error occurred while fetching weather data: " + ioException.getMessage(),</span>
<span class="source-line-no">400</span><span id="line-400">        API_ENDPOINT_URL,</span>
<span class="source-line-no">401</span><span id="line-401">        null,</span>
<span class="source-line-no">402</span><span id="line-402">        ioException);</span>
<span class="source-line-no">403</span><span id="line-403">  }</span>
<span class="source-line-no">404</span><span id="line-404"></span>
<span class="source-line-no">405</span><span id="line-405">  /**</span>
<span class="source-line-no">406</span><span id="line-406">   * Waits for the retry delay period.</span>
<span class="source-line-no">407</span><span id="line-407">   *</span>
<span class="source-line-no">408</span><span id="line-408">   * @throws NetworkException if the thread is interrupted during the wait</span>
<span class="source-line-no">409</span><span id="line-409">   */</span>
<span class="source-line-no">410</span><span id="line-410">  private void waitForRetry() throws NetworkException {</span>
<span class="source-line-no">411</span><span id="line-411">    try {</span>
<span class="source-line-no">412</span><span id="line-412">      Thread.sleep(retryDelayMs);</span>
<span class="source-line-no">413</span><span id="line-413">    } catch (InterruptedException ie) {</span>
<span class="source-line-no">414</span><span id="line-414">      Thread.currentThread().interrupt();</span>
<span class="source-line-no">415</span><span id="line-415">      throw new NetworkException(</span>
<span class="source-line-no">416</span><span id="line-416">          "Request was interrupted while fetching weather data", API_ENDPOINT_URL, null, ie);</span>
<span class="source-line-no">417</span><span id="line-417">    }</span>
<span class="source-line-no">418</span><span id="line-418">  }</span>
<span class="source-line-no">419</span><span id="line-419"></span>
<span class="source-line-no">420</span><span id="line-420">  /**</span>
<span class="source-line-no">421</span><span id="line-421">   * Validates the method parameters.</span>
<span class="source-line-no">422</span><span id="line-422">   *</span>
<span class="source-line-no">423</span><span id="line-423">   * @param cityName the city name to validate</span>
<span class="source-line-no">424</span><span id="line-424">   * @param apiKey the API key to validate</span>
<span class="source-line-no">425</span><span id="line-425">   * @throws IllegalArgumentException if either parameter is null or empty</span>
<span class="source-line-no">426</span><span id="line-426">   */</span>
<span class="source-line-no">427</span><span id="line-427">  private void validateParameters(final String cityName, final String apiKey) {</span>
<span class="source-line-no">428</span><span id="line-428">    if (cityName == null || cityName.isBlank()) {</span>
<span class="source-line-no">429</span><span id="line-429">      throw new IllegalArgumentException("City name must not be null or empty");</span>
<span class="source-line-no">430</span><span id="line-430">    }</span>
<span class="source-line-no">431</span><span id="line-431">    if (apiKey == null || apiKey.isBlank()) {</span>
<span class="source-line-no">432</span><span id="line-432">      throw new IllegalArgumentException("API key must not be null or empty");</span>
<span class="source-line-no">433</span><span id="line-433">    }</span>
<span class="source-line-no">434</span><span id="line-434">  }</span>
<span class="source-line-no">435</span><span id="line-435"></span>
<span class="source-line-no">436</span><span id="line-436">  /**</span>
<span class="source-line-no">437</span><span id="line-437">   * Builds the HTTP request for the weather API.</span>
<span class="source-line-no">438</span><span id="line-438">   *</span>
<span class="source-line-no">439</span><span id="line-439">   * @param cityName the city name</span>
<span class="source-line-no">440</span><span id="line-440">   * @param apiKey the API key</span>
<span class="source-line-no">441</span><span id="line-441">   * @return the constructed HTTP request</span>
<span class="source-line-no">442</span><span id="line-442">   */</span>
<span class="source-line-no">443</span><span id="line-443">  private HttpRequest buildRequest(final String cityName, final String apiKey) {</span>
<span class="source-line-no">444</span><span id="line-444">    final String url =</span>
<span class="source-line-no">445</span><span id="line-445">        API_ENDPOINT_URL</span>
<span class="source-line-no">446</span><span id="line-446">            + "?"</span>
<span class="source-line-no">447</span><span id="line-447">            + PARAM_CITY</span>
<span class="source-line-no">448</span><span id="line-448">            + "="</span>
<span class="source-line-no">449</span><span id="line-449">            + encodeParameter(cityName.trim())</span>
<span class="source-line-no">450</span><span id="line-450">            + "&amp;"</span>
<span class="source-line-no">451</span><span id="line-451">            + PARAM_API_KEY</span>
<span class="source-line-no">452</span><span id="line-452">            + "="</span>
<span class="source-line-no">453</span><span id="line-453">            + encodeParameter(apiKey.trim())</span>
<span class="source-line-no">454</span><span id="line-454">            + "&amp;"</span>
<span class="source-line-no">455</span><span id="line-455">            + PARAM_UNITS</span>
<span class="source-line-no">456</span><span id="line-456">            + "="</span>
<span class="source-line-no">457</span><span id="line-457">            + UNITS_STANDARD;</span>
<span class="source-line-no">458</span><span id="line-458"></span>
<span class="source-line-no">459</span><span id="line-459">    return HttpRequest.newBuilder()</span>
<span class="source-line-no">460</span><span id="line-460">        .uri(URI.create(url))</span>
<span class="source-line-no">461</span><span id="line-461">        .timeout(connectionTimeout)</span>
<span class="source-line-no">462</span><span id="line-462">        .header("Accept", "application/json")</span>
<span class="source-line-no">463</span><span id="line-463">        .GET()</span>
<span class="source-line-no">464</span><span id="line-464">        .build();</span>
<span class="source-line-no">465</span><span id="line-465">  }</span>
<span class="source-line-no">466</span><span id="line-466"></span>
<span class="source-line-no">467</span><span id="line-467">  /**</span>
<span class="source-line-no">468</span><span id="line-468">   * Encodes a parameter value for URL inclusion.</span>
<span class="source-line-no">469</span><span id="line-469">   *</span>
<span class="source-line-no">470</span><span id="line-470">   * @param value the parameter value to encode</span>
<span class="source-line-no">471</span><span id="line-471">   * @return the URL-encoded value</span>
<span class="source-line-no">472</span><span id="line-472">   */</span>
<span class="source-line-no">473</span><span id="line-473">  private String encodeParameter(final String value) {</span>
<span class="source-line-no">474</span><span id="line-474">    return java.net.URLEncoder.encode(value, java.nio.charset.StandardCharsets.UTF_8);</span>
<span class="source-line-no">475</span><span id="line-475">  }</span>
<span class="source-line-no">476</span><span id="line-476"></span>
<span class="source-line-no">477</span><span id="line-477">  /**</span>
<span class="source-line-no">478</span><span id="line-478">   * Handles the HTTP response and maps it to the appropriate result or exception.</span>
<span class="source-line-no">479</span><span id="line-479">   *</span>
<span class="source-line-no">480</span><span id="line-480">   * @param response the HTTP response</span>
<span class="source-line-no">481</span><span id="line-481">   * @return the parsed WeatherData object</span>
<span class="source-line-no">482</span><span id="line-482">   * @throws ApiKeyException if HTTP 401</span>
<span class="source-line-no">483</span><span id="line-483">   * @throws CityNotFoundException if HTTP 404</span>
<span class="source-line-no">484</span><span id="line-484">   * @throws RateLimitException if HTTP 429</span>
<span class="source-line-no">485</span><span id="line-485">   * @throws NetworkException for other error conditions</span>
<span class="source-line-no">486</span><span id="line-486">   */</span>
<span class="source-line-no">487</span><span id="line-487">  private WeatherData handleResponse(final HttpResponse&lt;String&gt; response)</span>
<span class="source-line-no">488</span><span id="line-488">      throws ApiKeyException, CityNotFoundException, RateLimitException, NetworkException {</span>
<span class="source-line-no">489</span><span id="line-489">    final int statusCode = response.statusCode();</span>
<span class="source-line-no">490</span><span id="line-490"></span>
<span class="source-line-no">491</span><span id="line-491">    if (HttpURLConnection.HTTP_OK == statusCode) {</span>
<span class="source-line-no">492</span><span id="line-492">      return parseWeatherData(response.body());</span>
<span class="source-line-no">493</span><span id="line-493">    }</span>
<span class="source-line-no">494</span><span id="line-494">    handleErrorStatus(statusCode, response);</span>
<span class="source-line-no">495</span><span id="line-495">    throw new NetworkException("Unexpected error handling response", API_ENDPOINT_URL, null, null);</span>
<span class="source-line-no">496</span><span id="line-496">  }</span>
<span class="source-line-no">497</span><span id="line-497"></span>
<span class="source-line-no">498</span><span id="line-498">  private void handleErrorStatus(final int statusCode, final HttpResponse&lt;String&gt; response)</span>
<span class="source-line-no">499</span><span id="line-499">      throws ApiKeyException, CityNotFoundException, RateLimitException, NetworkException {</span>
<span class="source-line-no">500</span><span id="line-500">    final String responseBody = response.body();</span>
<span class="source-line-no">501</span><span id="line-501"></span>
<span class="source-line-no">502</span><span id="line-502">    switch (statusCode) {</span>
<span class="source-line-no">503</span><span id="line-503">      case UNAUTH_STATUS:</span>
<span class="source-line-no">504</span><span id="line-504">        throw new ApiKeyException("Invalid or missing API key");</span>
<span class="source-line-no">505</span><span id="line-505">      case NOT_FOUND_STATUS:</span>
<span class="source-line-no">506</span><span id="line-506">        final String errorMessage = extractErrorMessage(responseBody);</span>
<span class="source-line-no">507</span><span id="line-507">        throw new CityNotFoundException("City not found: " + errorMessage);</span>
<span class="source-line-no">508</span><span id="line-508">      case RATE_LIMIT_STATUS:</span>
<span class="source-line-no">509</span><span id="line-509">        final long retryAfterSeconds = extractRetryAfterSeconds(response);</span>
<span class="source-line-no">510</span><span id="line-510">        throw new RateLimitException(</span>
<span class="source-line-no">511</span><span id="line-511">            "Rate limit exceeded. Retry after " + retryAfterSeconds + " seconds",</span>
<span class="source-line-no">512</span><span id="line-512">            (int) retryAfterSeconds);</span>
<span class="source-line-no">513</span><span id="line-513">      default:</span>
<span class="source-line-no">514</span><span id="line-514">        handleOtherError(statusCode, responseBody);</span>
<span class="source-line-no">515</span><span id="line-515">    }</span>
<span class="source-line-no">516</span><span id="line-516">  }</span>
<span class="source-line-no">517</span><span id="line-517"></span>
<span class="source-line-no">518</span><span id="line-518">  private void handleOtherError(final int statusCode, final String responseBody)</span>
<span class="source-line-no">519</span><span id="line-519">      throws NetworkException {</span>
<span class="source-line-no">520</span><span id="line-520">    if (statusCode &gt;= SERVER_ERR_STATUS) {</span>
<span class="source-line-no">521</span><span id="line-521">      throw new NetworkException(</span>
<span class="source-line-no">522</span><span id="line-522">          "Server error (HTTP " + statusCode + "): " + responseBody, API_ENDPOINT_URL, statusCode);</span>
<span class="source-line-no">523</span><span id="line-523">    }</span>
<span class="source-line-no">524</span><span id="line-524">    throw new NetworkException(</span>
<span class="source-line-no">525</span><span id="line-525">        "Unexpected HTTP status " + statusCode + ": " + responseBody, API_ENDPOINT_URL, statusCode);</span>
<span class="source-line-no">526</span><span id="line-526">  }</span>
<span class="source-line-no">527</span><span id="line-527"></span>
<span class="source-line-no">528</span><span id="line-528">  /**</span>
<span class="source-line-no">529</span><span id="line-529">   * Parses the JSON response body into a WeatherData object.</span>
<span class="source-line-no">530</span><span id="line-530">   *</span>
<span class="source-line-no">531</span><span id="line-531">   * @param jsonResponse the JSON response body</span>
<span class="source-line-no">532</span><span id="line-532">   * @return the parsed WeatherData object</span>
<span class="source-line-no">533</span><span id="line-533">   * @throws NetworkException if parsing fails</span>
<span class="source-line-no">534</span><span id="line-534">   */</span>
<span class="source-line-no">535</span><span id="line-535">  private WeatherData parseWeatherData(final String jsonResponse) throws NetworkException {</span>
<span class="source-line-no">536</span><span id="line-536">    if (jsonResponse == null || jsonResponse.isEmpty()) {</span>
<span class="source-line-no">537</span><span id="line-537">      throw new NetworkException(</span>
<span class="source-line-no">538</span><span id="line-538">          "Empty or null response body from API", API_ENDPOINT_URL, null, null);</span>
<span class="source-line-no">539</span><span id="line-539">    }</span>
<span class="source-line-no">540</span><span id="line-540">    try {</span>
<span class="source-line-no">541</span><span id="line-541">      return objectMapper.readValue(jsonResponse, WeatherData.class);</span>
<span class="source-line-no">542</span><span id="line-542">    } catch (final com.fasterxml.jackson.core.JsonProcessingException e) {</span>
<span class="source-line-no">543</span><span id="line-543">      throw new NetworkException(</span>
<span class="source-line-no">544</span><span id="line-544">          "Failed to parse weather data from response: " + e.getMessage(),</span>
<span class="source-line-no">545</span><span id="line-545">          API_ENDPOINT_URL,</span>
<span class="source-line-no">546</span><span id="line-546">          null,</span>
<span class="source-line-no">547</span><span id="line-547">          e);</span>
<span class="source-line-no">548</span><span id="line-548">    }</span>
<span class="source-line-no">549</span><span id="line-549">  }</span>
<span class="source-line-no">550</span><span id="line-550"></span>
<span class="source-line-no">551</span><span id="line-551">  /**</span>
<span class="source-line-no">552</span><span id="line-552">   * Extracts error message from the API error response.</span>
<span class="source-line-no">553</span><span id="line-553">   *</span>
<span class="source-line-no">554</span><span id="line-554">   * @param responseBody the error response body</span>
<span class="source-line-no">555</span><span id="line-555">   * @return the extracted error message, or a default message if extraction fails</span>
<span class="source-line-no">556</span><span id="line-556">   */</span>
<span class="source-line-no">557</span><span id="line-557">  private String extractErrorMessage(final String responseBody) {</span>
<span class="source-line-no">558</span><span id="line-558">    String errorMessage = "Unknown error";</span>
<span class="source-line-no">559</span><span id="line-559">    try {</span>
<span class="source-line-no">560</span><span id="line-560">      final com.fasterxml.jackson.databind.JsonNode root = objectMapper.readTree(responseBody);</span>
<span class="source-line-no">561</span><span id="line-561">      final com.fasterxml.jackson.databind.JsonNode messageNode = root.get("message");</span>
<span class="source-line-no">562</span><span id="line-562">      if (messageNode != null) {</span>
<span class="source-line-no">563</span><span id="line-563">        errorMessage = messageNode.asText();</span>
<span class="source-line-no">564</span><span id="line-564">      }</span>
<span class="source-line-no">565</span><span id="line-565">    } catch (final com.fasterxml.jackson.core.JsonProcessingException e) {</span>
<span class="source-line-no">566</span><span id="line-566">      errorMessage = "Unable to parse error message";</span>
<span class="source-line-no">567</span><span id="line-567">    }</span>
<span class="source-line-no">568</span><span id="line-568">    return errorMessage;</span>
<span class="source-line-no">569</span><span id="line-569">  }</span>
<span class="source-line-no">570</span><span id="line-570"></span>
<span class="source-line-no">571</span><span id="line-571">  /**</span>
<span class="source-line-no">572</span><span id="line-572">   * Extracts the Retry-After seconds from the rate limit response headers.</span>
<span class="source-line-no">573</span><span id="line-573">   *</span>
<span class="source-line-no">574</span><span id="line-574">   * @param response the HTTP response</span>
<span class="source-line-no">575</span><span id="line-575">   * @return the retry-after seconds, or 0 if not available</span>
<span class="source-line-no">576</span><span id="line-576">   */</span>
<span class="source-line-no">577</span><span id="line-577">  private long extractRetryAfterSeconds(final HttpResponse&lt;String&gt; response) {</span>
<span class="source-line-no">578</span><span id="line-578">    long retryAfterSeconds = 0;</span>
<span class="source-line-no">579</span><span id="line-579">    final String retryAfterHeader = response.headers().firstValue("Retry-After").orElse(null);</span>
<span class="source-line-no">580</span><span id="line-580">    if (retryAfterHeader != null) {</span>
<span class="source-line-no">581</span><span id="line-581">      try {</span>
<span class="source-line-no">582</span><span id="line-582">        retryAfterSeconds = Long.parseLong(retryAfterHeader);</span>
<span class="source-line-no">583</span><span id="line-583">      } catch (final NumberFormatException e) {</span>
<span class="source-line-no">584</span><span id="line-584">        // Log the error but ignore parsing errors, return 0</span>
<span class="source-line-no">585</span><span id="line-585">        // In production, this would use a proper logger</span>
<span class="source-line-no">586</span><span id="line-586">        final Logger logger = Logger.getLogger(DefaultOpenWeatherApiClient.class.getName());</span>
<span class="source-line-no">587</span><span id="line-587">        if (logger.isLoggable(java.util.logging.Level.WARNING)) {</span>
<span class="source-line-no">588</span><span id="line-588">          logger.warning("Invalid Retry-After header format: " + retryAfterHeader);</span>
<span class="source-line-no">589</span><span id="line-589">        }</span>
<span class="source-line-no">590</span><span id="line-590">      }</span>
<span class="source-line-no">591</span><span id="line-591">    }</span>
<span class="source-line-no">592</span><span id="line-592">    return retryAfterSeconds;</span>
<span class="source-line-no">593</span><span id="line-593">  }</span>
<span class="source-line-no">594</span><span id="line-594">}</span>




























































</pre>
</div>
</main>
</body>
</html>
